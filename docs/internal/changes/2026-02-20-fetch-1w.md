# 2026-02-20: Fetch 1w (Weekly) Resample Path

## What Changed

- **Weekly fetch path implemented**: `ohlcv-hub fetch --tf 1w` now fetches daily bars from Alpaca, resamples to weekly (Monday 00:00 UTC), validates, and exports.
- **New module**: `ohlcv_hub/resample.py` with `to_weekly()` (W-MON, label left, closed left).
- **Validation**: Added `validate_weekly_bars()`; refactored shared `_validate_bars_issues()`. Weekly report omits missing-days (empty totals).
- **Dataset**: Added `build_weekly_dataset()` (fetch daily → normalize → resample → validate).
- **CLI**: Unified fetch flow for 1d and 1w; removed "not implemented" for 1w. Fixed `typer.Exit(0)` being caught by generic `except Exception`.
- **Tests**: New `tests/test_fetch_1w_integration_mocked.py`; parsing tests updated for new exit semantics; 1d test that expected weekly exit 2 removed.

## Files Touched

### Added
- `ohlcv_hub/resample.py`
- `tests/test_fetch_1w_integration_mocked.py`
- `docs/llm-handoff/feature4-weekly-plan-2026-02-20.md`
- `docs/changes/2026-02-20-fetch-1w.md`

### Modified
- `ohlcv_hub/validate.py` — `_validate_bars_issues()`, `validate_weekly_bars()`, `validate_daily_bars()` refactor
- `ohlcv_hub/dataset.py` — `build_weekly_dataset()`
- `ohlcv_hub/cli.py` — 1w path, shared fetch flow, `except typer.Exit` re-raise
- `tests/test_fetch_1d_integration_mocked.py` — removed test that expected 1w exit 2
- `tests/test_cli_fetch_parsing.py` — parsing tests now expect exit 1 without config / clear env

## Key Decisions

- **W-MON policy**: Weekly bars use Monday 00:00 UTC (pandas `resample('W-MON', label='left', closed='left')`). Input `ts` must be tz-aware UTC and set as index before resample.
- **Missing days skipped for weekly**: `validate_weekly_bars()` uses the same report schema as daily but sets `missing_days` to `{"totals": {"missing_days_count_total": 0}}` (no NYSE calendar run for weekly).
- **Export-on-validation-error**: Same as daily: export even when there are validation issues, then exit 1.
- **Exit handling**: `typer.Exit` is re-raised so success (exit 0) is not turned into a generic error (exit 1).

## How to Test

- **Automated**: `pytest -q` (all tests pass, no network).
- **Manual (real keys)**:
  - `ohlcv-hub fetch --symbols SPY,QQQ --start 2024-01-01 --end 2024-03-01 --tf 1w --out ./data --format parquet --report`
  - Confirm `ohlcv_1w_*.parquet` and `validation_report.json` exist; weekly `ts` are Mondays 00:00 UTC.

## TODOs

- Optional weekly missing-days (e.g. “expected weeks” vs present) if needed later.
- Performance/partitioning: single file per run; consider partitioning by symbol/date for large runs.
