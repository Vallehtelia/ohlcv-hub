# 2026-02-20: Retry/backoff for HTTP 429

## What changed

- **AlpacaClient** now retries the same request when the Alpaca API returns **HTTP 429** (rate limit).
- **Bounds**: Up to 5 retries per request (total attempts = 1 + 5 = 6). Max sleep per wait = 5.0 seconds.
- **Sleep guidance**: `Retry-After` header (seconds, cap 5s); else `X-RateLimit-Reset` (unix epoch) → wait = reset - now (cap 5s, floor 0); else exponential backoff 0.5, 1, 2, 4 seconds (capped at 5).
- **Sleeper injection**: Optional `sleeper: Callable[[float], None]` in `AlpacaClient.__init__` (default `time.sleep`) so tests can use a spy and avoid real sleeps.
- **Non-429**: Unchanged — no retry for 401, 403, 400, 500, etc.; same `ProviderError` as before.
- **Exhausted retries**: Raise `ProviderError` with `status_code=429` and message including "retries exhausted".

## Files touched

- `ohlcv_hub/providers/alpaca.py` — constants, `_sleep`, `_compute_sleep_seconds_for_429`, retry loop for 429.
- `tests/test_alpaca_client_pagination.py` — `test_retries_on_429_then_succeeds_without_sleeping_real_time`, `test_exhausts_retries_and_raises_provider_error_429`.
- `docs/llm-handoff/feature5b-retry-429-plan-2026-02-20.md` — plan.
- `docs/changes/2026-02-20-retry-429.md` — this file.

## How to test

- **Automated**: `pytest -q` (all tests pass; no real sleep in tests).
- **Manual**: Trigger 429 from Alpaca (e.g. burst requests) and confirm retries then success or exhausted error.

## TODOs

- **Jitter**: Add optional jitter to sleep to avoid thundering herd.
- **Global rate limiter**: Optional process-wide rate limiter for multiple symbols/ranges.
